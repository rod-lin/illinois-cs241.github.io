<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="images/favicons/manifest.json">
  <link rel="mask-icon" href="images/favicons/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">

  <title>Networking, Part 4: Building a simple TCP Server</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">
  <link async rel="stylesheet" href="/css/code-style.css?v=2018-09-08 16:51:38 +0000">
  <link rel="stylesheet" href="/css/main.css?v=2018-09-08 16:51:38 +0000">

</head>

<body>
<!-- Always shows a header, even in smaller screens. -->
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">

            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>

            <a id="tuxlink"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAJCAMAAAA4jZ0cAAAAM1BMVEX///8CAgQMDAwsLCw0NDSjbQCkbQC+vbzOkwDU1NTlrADqvADxtgD0vQD12wD+/vz+//yBSdYEAAAAAXRSTlMAQObYZgAAADFJREFUCB0FwQkCQDAQBLCsq6g1/v9aCVQBthUwX8BIgStZCpUvKXSSLs6eyd0Pdg5+JwkBVyC74QYAAAAASUVORK5CYII=" title="Tux" alt="Tux" style="margin-left: 1em; width: 24px; filter: drop-shadow(1px 1px 0 white) drop-shadow(1px -1px 0 white) drop-shadow(-1px 1px 0 white) drop-shadow(-1px -1px 0 white); margin-top: 1em;"/></a>

            <a class="navbar-brand navbar-link normal" href="/">CS 241: System Programming</a>
            <a class="navbar-brand navbar-link small" href="/">CS 241</a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li>
            <a class="navbar-link" href="/mps.html">MPs</a>
            </li>
            <li>
            <a class="navbar-link" href="/labs.html">Labs</a>
            </li>
            <li>
            <a class="navbar-link" href="/help.html">Help!</a>
            </li>
            <li>
            <a class="navbar-link" href="/schedule.html">Schedule</a>
            </li>
            <li>
            <a class="navbar-link" href="/honors.html">Honors</a>
            </li>
            <li>
            <a class="navbar-link" href="/staff.html">The Crew</a>
            </li>
            <li>
            <a class="navbar-link" href="/search.html">Search</a>
            </li>
            <li>
            <a class="navbar-link" href="/wikibook/home.html">Wikibook</a>
            </li>
          </ul>
        </div>
        </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-2 col-sm-1 col-xs-0"></div>
    <div class="col-md-8 col-sm-10 col-xs-12">
      <div class="wrapper">
        <div class="pad"><div class="card">
          <div class="title">
            <div class="speaker-wrapper">
              <button onclick="speak()" class="speaker" alt="Read Page"></button>
            </div>
            <h1>
              Networking, Part 4: Building a simple TCP Server
              
                <a class="github-link hidden-xs" href="https://github.com/angrave/SystemProgramming/wiki//Networking,-Part-4:-Building-a-simple-TCP-Server">Edit on Github</a>
              
            </h1>
          </div>
          <div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
            
          </div></div></div>
        </div></div>
      </div>
      <div class="toc-wrapper">
<h4>Content</h4>
<ul class="toc">
<li><a id="toc_what-is-htons-and-when-is-it-used" href="#what-is-htons-and-when-is-it-used" class="fancy-link">What is <code class="highlighter-rouge">htons</code> and when is it used?</a></li>
<li><a id="toc_what-are-the-big-4-network-calls-used-to-create-a-server" href="#what-are-the-big-4-network-calls-used-to-create-a-server" class="fancy-link">What are the ‘big 4’ network calls used to create a server?</a></li>
<li><a id="toc_what-is-the-purpose-of-calling-socket" href="#what-is-the-purpose-of-calling-socket" class="fancy-link">What is the purpose of calling <code class="highlighter-rouge">socket</code>?</a></li>
<li><a id="toc_what-is-the-purpose-of-calling-bind" href="#what-is-the-purpose-of-calling-bind" class="fancy-link">What is the purpose of calling <code class="highlighter-rouge">bind</code>?</a></li>
<li><a id="toc_what-is-the-purpose-of-calling-listen" href="#what-is-the-purpose-of-calling-listen" class="fancy-link">What is the purpose of calling <code class="highlighter-rouge">listen</code>?</a></li>
<li><a id="toc_why-are-server-sockets-passive" href="#why-are-server-sockets-passive" class="fancy-link">Why are server sockets passive?</a></li>
<li><a id="toc_what-is-the-purpose-of-calling-accept" href="#what-is-the-purpose-of-calling-accept" class="fancy-link">What is the purpose of calling <code class="highlighter-rouge">accept</code>?</a></li>
<li><a id="toc_what-are-the-gotchas-of-creating-a-tcp-server" href="#what-are-the-gotchas-of-creating-a-tcp-server" class="fancy-link">What are the gotchas of creating a TCP-server?</a></li>
<li><a id="toc_server-code-example" href="#server-code-example" class="fancy-link">Server code example</a></li>
<li><a id="toc_why-cant-my-server-re-use-the-port" href="#why-cant-my-server-re-use-the-port" class="fancy-link">Why can’t my server re-use the port?</a></li>
</ul>
</div>
      <div id="content">
        
        <div class="wrapper">

</div>
        <div class="wrapper">
<div class="pad"><div class="card">
<div class="title"><h2 id="what-is-htons-and-when-is-it-used" class="title-text">What is <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/htons" class="fancy-link">htons</a></code> and when is it used?<a class="anchor title-text" href="#what-is-htons-and-when-is-it-used">#</a>
</h2></div>









<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>Integers can be represented in least significant byte first or most-significant byte first. Either approach is reasonable as long as the machine itself is internally consistent. For network communications we need to standardize on agreed format.</p>
<p><code class="highlighter-rouge">htons(xyz)</code> returns the 16 bit unsigned integer ‘short’ value xyz in network byte order.
<code class="highlighter-rouge">htonl(xyz)</code> returns the 32 bit unsigned integer ‘long’ value xyz in network byte order.</p>
<p>These functions are read as ‘host to network’; the inverse functions (ntohs, ntohl) convert network ordered byte values to host-ordered ordering. So, is host-ordering  little-endian or big-endian? The answer is - it depends on your machine! It depends on the actual architecture of the host running the code. If the architecture happens to be the same as network ordering then the result of these functions is just the argument. For x86 machines, the host and network ordering <em>is</em> different.</p>
<p>Summary: Whenever you read or write the low level C network structures (e.g. port and address information), remember to use the above functions to ensure correct conversion to/from a machine format. Otherwise the displayed or specified value may be incorrect.</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="what-are-the-big-4-network-calls-used-to-create-a-server" class="title-text">What are the ‘big 4’ network calls used to create a server?<a class="anchor title-text" href="#what-are-the-big-4-network-calls-used-to-create-a-server">#</a>
</h2></div>







<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>The four system calls required to create a TCP server are: <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/socket" class="fancy-link">socket</a></code>, <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/bind" class="fancy-link">bind</a></code>, <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/listen" class="fancy-link">listen</a></code> and <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/accept" class="fancy-link">accept</a></code>. Each has a specific purpose and should be called in the above order</p>
<p>The port information (used by bind) can be set manually (many older IPv4-only C code examples do this), or be created using <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/getaddrinfo" class="fancy-link">getaddrinfo</a></code></p>
<p>We also see examples of setsockopt later too.</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="what-is-the-purpose-of-calling-socket" class="title-text">What is the purpose of calling <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/socket" class="fancy-link">socket</a></code>?<a class="anchor title-text" href="#what-is-the-purpose-of-calling-socket">#</a>
</h2></div>



<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1"><p>To create a endpoint for networking communication. A new socket by itself is not particularly useful; though we’ve specified either a packet or stream-based connections it is not bound to a particular network interface or port. Instead socket returns a network descriptor that can be used with later calls to bind, listen and accept.</p></div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="what-is-the-purpose-of-calling-bind" class="title-text">What is the purpose of calling <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/bind" class="fancy-link">bind</a></code>?<a class="anchor title-text" href="#what-is-the-purpose-of-calling-bind">#</a>
</h2></div>



<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1"><p>The <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/bind" class="fancy-link">bind</a></code> call associates an abstract socket with an actual network interface and port. It is possible to call bind on a TCP client however it’s unusually unnecessary to specify the outgoing port.</p></div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="what-is-the-purpose-of-calling-listen" class="title-text">What is the purpose of calling <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/listen" class="fancy-link">listen</a></code>?<a class="anchor title-text" href="#what-is-the-purpose-of-calling-listen">#</a>
</h2></div>



<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1"><p>The <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/listen" class="fancy-link">listen</a></code> call specifies the queue size for the number of incoming, unhandled connections i.e. that have not yet been assigned a network descriptor by <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/accept" class="fancy-link">accept</a></code>
Typical values for a high performance server are 128 or more.</p></div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="why-are-server-sockets-passive" class="title-text">Why are server sockets passive?<a class="anchor title-text" href="#why-are-server-sockets-passive">#</a>
</h2></div>





<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>Server sockets do not actively try to connect to another host; instead they wait for incoming connections. Additionally, server sockets are not closed when the peer disconnects. Instead the client communicates with a separate active socket on the server that is specific to that connection.</p>
<p>Unique TCP connections are identified by the tuple <code class="highlighter-rouge">(source ip, source port, destination ip, destination port)</code>
It is possible to have multiple connections from a web browser to the same server port (e.g. port 80) because the the source port on each arriving packet is unique. i.e. For a particular server port (e.g. port 80) there can be one passive server socket but multiple active sockets (one for each currently open connection) and the server’s operating system maintains a lookup table that associates a unique tuple with active sockets, so that incoming packets can be correctly routed to the correct socket.</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="what-is-the-purpose-of-calling-accept" class="title-text">What is the purpose of calling <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/accept" class="fancy-link">accept</a></code>?<a class="anchor title-text" href="#what-is-the-purpose-of-calling-accept">#</a>
</h2></div>





<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>Once the server socket has been initialized the server calls <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/accept" class="fancy-link">accept</a></code> to wait for new connections. Unlike <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/socket" class="fancy-link">socket</a></code> <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/bind" class="fancy-link">bind</a></code> and <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/listen" class="fancy-link">listen</a></code>, this call will block. i.e. if there are no new connections, this call will block and only return when a new client connects. The returned TCP socket is associated with a particular tuple <code class="highlighter-rouge">(client IP, client port, server IP, server port)</code> and will be used for all future incoming and outgoing TCP packets that match this tuple.</p>
<p>Note the <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/accept" class="fancy-link">accept</a></code> call returns a new file descriptor. This file descriptor is specific to a particular client. It is common programming mistake to use the original server socket descriptor for server I/O and then wonder why networking code has failed.</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="what-are-the-gotchas-of-creating-a-tcp-server" class="title-text">What are the gotchas of creating a TCP-server?<a class="anchor title-text" href="#what-are-the-gotchas-of-creating-a-tcp-server">#</a>
</h2></div>





<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<ul>
  <li>Using the socket descriptor of the passive server socket (described above)</li>
  <li>Not specifying SOCK_STREAM requirement for getaddrinfo</li>
  <li>Not being able to re-use an existing port.</li>
  <li>Not initializing the unused struct entries</li>
  <li>The <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/bind" class="fancy-link">bind</a></code> call will fail if the port is currently in use</li>
</ul>
<p>Note, ports are per machine- not per process or per user. In other words,  you cannot use port 1234 while another process is using that port. Worse, ports are by default ‘tied up’ after a process has finished.</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="server-code-example" class="title-text">Server code example<a class="anchor title-text" href="#server-code-example">#</a>
</h2></div>





<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>A working simple server example is shown below. Note this example is incomplete - for example it does not close either socket descriptor, or free up memory created by <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/getaddrinfo" class="fancy-link">getaddrinfo</a></code></p>
<pre><code class="language-C"><a class="code-copy" rel="code-copy-0" onclick="onCopy(this);">Copy</a><span class="cp">#include &lt;string.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netdb.h&gt;
#include &lt;unistd.h&gt;
#include &lt;arpa/inet.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sock_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">addrinfo</span><span class="p">));</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">AI_PASSIVE</span><span class="p">;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"1234"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"getaddrinfo: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">gai_strerror</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"bind()"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"listen()"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">result_addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Listening on file descriptor %d, port %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sock_fd</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">result_addr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">));</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Waiting for connection...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">client_fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Connection made: client_fd=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">client_fd</span><span class="p">);</span>

    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Read %d chars</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"===</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<textarea id="code-copy-0" class="code-copy-textarea" value="#include &amp;lt;string.h&amp;gt;
#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;stdlib.h&amp;gt;
#include &amp;lt;sys/types.h&amp;gt;
#include &amp;lt;sys/socket.h&amp;gt;
#include &amp;lt;netdb.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;arpa/inet.h&amp;gt;

int main(int argc, char **argv) {
    int s;
    int sock_fd = socket(AF_INET, SOCK_STREAM, 0);

    struct addrinfo hints, *result;
    memset(&amp;amp;hints, 0, sizeof (struct addrinfo));
    hints.ai_family = AF_INET;
    hints.ai_socktype = SOCK_STREAM;
    hints.ai_flags = AI_PASSIVE;

    s = getaddrinfo(NULL, &quot;1234&quot;, &amp;amp;hints, &amp;amp;result);
    if (s != 0) {
        fprintf(stderr, &quot;getaddrinfo: %s\n&quot;, gai_strerror(s));
        exit(1);
    }

    if (bind(sock_fd, result-&amp;gt;ai_addr, result-&amp;gt;ai_addrlen) != 0) {
        perror(&quot;bind()&quot;);
        exit(1);
    }

    if (listen(sock_fd, 10) != 0) {
        perror(&quot;listen()&quot;);
        exit(1);
    }
    
    struct sockaddr_in *result_addr = (struct sockaddr_in *) result-&amp;gt;ai_addr;
    printf(&quot;Listening on file descriptor %d, port %d\n&quot;, sock_fd, ntohs(result_addr-&amp;gt;sin_port));

    printf(&quot;Waiting for connection...\n&quot;);
    int client_fd = accept(sock_fd, NULL, NULL);
    printf(&quot;Connection made: client_fd=%d\n&quot;, client_fd);

    char buffer[1000];
    int len = read(client_fd, buffer, sizeof (buffer) - 1);
    buffer[len] = '\0';

    printf(&quot;Read %d chars\n&quot;, len);
    printf(&quot;===\n&quot;);
    printf(&quot;%s\n&quot;, buffer);

    return 0;
}
"></textarea></code></pre>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="why-cant-my-server-re-use-the-port" class="title-text">Why can’t my server re-use the port?<a class="anchor title-text" href="#why-cant-my-server-re-use-the-port">#</a>
</h2></div>







<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>By default a port is not immediately released when the server socket is closed. Instead, the port enters a “TIMED-WAIT” state. This can lead to significant confusion during development because the timeout can make valid networking code appear to fail.</p>
<p>To be able to immediately re-use a port, specify <code class="highlighter-rouge">SO_REUSEPORT</code> before binding to the port.</p>
<pre><code class="language-C"><a class="code-copy" rel="code-copy-1" onclick="onCopy(this);">Copy</a><span class="kt">int</span> <span class="n">optval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">setsockopt</span><span class="p">(</span><span class="n">sfd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEPORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">optval</span><span class="p">));</span>

<span class="n">bind</span><span class="p">(....</span>
<textarea id="code-copy-1" class="code-copy-textarea" value="int optval = 1;
setsockopt(sfd, SOL_SOCKET, SO_REUSEPORT, &amp;amp;optval, sizeof (optval));

bind(....
"></textarea></code></pre>
<p>Here’s <a href="http://stackoverflow.com/questions/14388706/socket-options-so-reuseaddr-and-so-reuseport-how-do-they-differ-do-they-mean-t" class="fancy-link wiki-link">an extended stackoverflow introductory discussion of <code class="highlighter-rouge">SO_REUSEPORT</code></a>.</p>
</div></div></div>
</div></div>
</div>
        
        <div class="wrapper">
</div>
      </div>
      <div class="col-md-2 col-sm-1 col-xs-0"></div>
    </div>
  </div>
  <script>
    var github_repo = "illinois-cs241/illinois-cs241.github.io";
    var github_path = "_wikibook/networking-part-4-building-a-simple-tcp-server.md";
  </script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" crossorigin="anonymous"></script>
<script src="/js/main.js?v=2018-09-08 16:51:38 +0000"></script>

<script>
$(document).ready(function() { 
    $("#tuxlink").prop("href", "javascript:;").click(function() { 
        if ("WebkitAppearance" in document.documentElement.style) { 
            var style = document.createElement("style"); 
            style.setAttribute("id", "tuxstyle"); 
            style.appendChild(document.createTextNode("")); 
            document.head.appendChild(style); 
            var sheet = style.sheet;
            sheet.insertRule("::-webkit-scrollbar-thumb {border-radius: 0; background-color: white; -webkit-box-shadow: none;}", 0); 
        } 

        const hackerKey = 'hackerLocalKey';
        const hackerOff = "off";
        const hackerOn = "on";

        if (window.localStorage.getItem(hackerKey) === null) {
            window.localStorage.setItem(hackerKey, hackerOff);
        }

        $("#tuxlink").unbind('click').click(function() { 
            const hackerClass = 'hacker';
            $('html, body, header, nav, table, pre, span, :not(.card-staff) > a, p, h1, h2, h3, h4, h5, h6').toggleClass(hackerClass);
            $('ul, img, pre').toggleClass(hackerClass);
            $('.toc').toggleClass(hackerClass);
            $('.content .highlighter-rouge').toggleClass(hackerClass);
            $('.large-centered.columns').toggleClass(hackerClass);
            $('.pad').toggleClass(hackerClass);
            $('a').toggleClass(hackerClass);
            $('tbody tr:nth-child(2n+1)').toggleClass(hackerClass);
            $("#tuxlink img").toggleClass(hackerClass);

            const val = window.localStorage.getItem(hackerKey);
            if (val === hackerOff) {
                window.localStorage.setItem(hackerKey, hackerOn);
            } else {
                window.localStorage.setItem(hackerKey, hackerOff);
            }
            return false; 
        }); 
        $("#tuxlink").click();
        const stored = window.localStorage.getItem(hackerKey);
        if (stored === hackerOn) {
            console.log("Hello!")
            $("#tuxlink").click();
        } else {
            console.log("Noo");
        }

        return false; 
    }); 
    } 
    ); 
    </script>

<script src="/js/analytics.js"></script>

<footer class="">

<div class="container-fluid">
<div class="shadow"></div>

</div>

</footer>

</body>
</html>
