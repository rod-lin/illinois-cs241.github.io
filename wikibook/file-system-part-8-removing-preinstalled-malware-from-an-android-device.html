<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="images/favicons/manifest.json">
  <link rel="mask-icon" href="images/favicons/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">

  <title>File System, Part 8: Removing preinstalled malware from an Android device</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">
  <link async rel="stylesheet" href="/css/code-style.css?v=2018-09-08 16:51:38 +0000">
  <link rel="stylesheet" href="/css/main.css?v=2018-09-08 16:51:38 +0000">

</head>

<body>
<!-- Always shows a header, even in smaller screens. -->
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">

            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>

            <a id="tuxlink"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAJCAMAAAA4jZ0cAAAAM1BMVEX///8CAgQMDAwsLCw0NDSjbQCkbQC+vbzOkwDU1NTlrADqvADxtgD0vQD12wD+/vz+//yBSdYEAAAAAXRSTlMAQObYZgAAADFJREFUCB0FwQkCQDAQBLCsq6g1/v9aCVQBthUwX8BIgStZCpUvKXSSLs6eyd0Pdg5+JwkBVyC74QYAAAAASUVORK5CYII=" title="Tux" alt="Tux" style="margin-left: 1em; width: 24px; filter: drop-shadow(1px 1px 0 white) drop-shadow(1px -1px 0 white) drop-shadow(-1px 1px 0 white) drop-shadow(-1px -1px 0 white); margin-top: 1em;"/></a>

            <a class="navbar-brand navbar-link normal" href="/">CS 241: System Programming</a>
            <a class="navbar-brand navbar-link small" href="/">CS 241</a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li>
            <a class="navbar-link" href="/mps.html">MPs</a>
            </li>
            <li>
            <a class="navbar-link" href="/labs.html">Labs</a>
            </li>
            <li>
            <a class="navbar-link" href="/help.html">Help!</a>
            </li>
            <li>
            <a class="navbar-link" href="/schedule.html">Schedule</a>
            </li>
            <li>
            <a class="navbar-link" href="/honors.html">Honors</a>
            </li>
            <li>
            <a class="navbar-link" href="/staff.html">The Crew</a>
            </li>
            <li>
            <a class="navbar-link" href="/search.html">Search</a>
            </li>
            <li>
            <a class="navbar-link" href="/wikibook/home.html">Wikibook</a>
            </li>
          </ul>
        </div>
        </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-2 col-sm-1 col-xs-0"></div>
    <div class="col-md-8 col-sm-10 col-xs-12">
      <div class="wrapper">
        <div class="pad"><div class="card">
          <div class="title">
            <div class="speaker-wrapper">
              <button onclick="speak()" class="speaker" alt="Read Page"></button>
            </div>
            <h1>
              File System, Part 8: Removing preinstalled malware from an Android device
              
                <a class="github-link hidden-xs" href="https://github.com/angrave/SystemProgramming/wiki//File-System,-Part-8:-Removing-preinstalled-malware-from-an-Android-device">Edit on Github</a>
              
            </h1>
          </div>
          <div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
            
          </div></div></div>
        </div></div>
      </div>
      <div class="toc-wrapper">
<h4>Content</h4>
<ul class="toc"></ul>
</div>
      <div id="content">
        
        <div class="wrapper">

</div>
        <div class="wrapper">
<p>Case study: Removing malware from an Android device</p>

<p>This section uses filesystem features and system programming tools discussed in this wikibook to find and remove unwanted malware from an Android tablet.</p>

<p>DISCLAIMER. ENSURE ANY VALUABLE INFORMATION ON YOUR DEVICE IS BACKED UP BEFORE ATTEMPTING TO MODIFY YOUR TABLET. MODIFYING SYSTEM SETTINGS AND SYSTEM FILES IS NOT RECOMMENDED. ATTEMPTING TO MODIFY A DEVICE USING THIS CASE STUDU GUIDE MAY CAUSE YOUR TABLET TO SHARE, LOSE OR CORRUPT YOUR DATA. FURTHER YOUR TABLET MAY FUNCTION INCORRECTLY OR TO STOP FUNCTIONING ALTOGETHER. USE THIS CASE STUDY AT YOUR OWN RISK. THE AUTHORS ASSUME NO RESPONSIBILITY AND MAKE NO WARRANTY ABOUT THE CORRECTNESS OR COMPLETENESS OF THESE INSTRUCTIONS INCLUDED IN THIS CASE STUDY. THE AUTHORS ASSUME NO RESPONSIBILITY AND MAKE NO WARRANTY ABOUT ANY SOFTWARE INCLUDING EXTERNAL THIRD PARTY SOFTWARE DESCRIBED OR LINKED TO IN THIS GUIDE.</p>

<div class="pad"><div class="card">


<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<h1 id="background">Background</h1>
<p>An E97 Android tablet purchased from Amazon had developed some peculiar quirks. Most noticeable was that the browser app always opened a website at gotoamazing.com rather than the home page set in the app’s preferences (known as browser ‘hijacking’). Can we use the knowledge from this wikibook to understand how this unwanted behavior occurs and also remove unwanted pre-installed apps from the device?</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">






<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<h1 id="tools-used">Tools used</h1>
<p>While it is possible to use the Android developer tools installed on a remote USB-connected machine, this guide uses only system tools on the tablet. The following apps were installed -</p>
<ul>
  <li>Malwarebytes - A free vulnerability and malware tool.</li>
  <li>Terminal emulator - A simple terminal window that gives us shell access on the tablet.</li>
  <li>KingRoot - A tool that uses known exploits in the linux kernel to gain root access.</li>
</ul>
<p>Installing any app can potentially allow arbitrary code to be executed if it is able to break out of the Android security model. Of the apps mentioned above, KingRoot is the most extreme example because it exploits system vulnerabilities to gain root access for our purposes. However in doing so, it could also 
Of these, KingRoot is the most questionable tool to install - we are trusting it not to install any of its own malware. A potentially safer alternative is to use https://github.com/android-rooting-tools/</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">





<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<h1 id="overview-of-terminal">Overview of terminal</h1>
<p>The most useful commands are  <code class="highlighter-rouge">su grep mount</code> and Android’s package manager tool, <code class="highlighter-rouge"><a href="https://linux.die.net/man/1/pm" class="fancy-link">pm</a></code>.</p>
<ul>
  <li>grep -s abc * <em>/</em>   (search for <code class="highlighter-rouge">abc</code> in current directory and immediate sub directories)</li>
  <li>su ( aka “switch user” become root - requires a rooted device)</li>
  <li>mount -o rw,remount /system  (allow /system partition to be writeable)</li>
  <li>pm disable  (aka ‘package manager’ disable an Android app package)</li>
</ul>
</div></div></div>
</div></div>
<div class="pad"><div class="card">


































<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<h1 id="overview-of-filesystem-layout">Overview of filesystem layout</h1>
<p>On this specific tablet that runs Android 4.4.2, pre-installed apps are unmodifiable and are located in</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/system/app/
/system/priv-app/
</code></pre></div></div>
<p>and preferences and app-data are stored in the <code class="highlighter-rouge">/data</code> partition
Each app is typically packaged inside an apk file, which is essentially a zip file. When an app is installed the code is expanded into a file that can be directly parsed by the Android virtual machine. The binary code (at least for this particular virtual machine) has an odex extension.</p>
<p>We can search the code of the installed system apps for the string ‘gotoamazing’</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>grep -s gotoamazing /system/app/* /system/priv-app/*
</code></pre></div></div>
<p>This didn’t find anything; it appears this string was not hardcoded into the source code of the given system apps. To verify that we can find</p>
<p>Let’s check the data area of all installed apps</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /data/data
grep -s gotoamazing * */* */*/*
</code></pre></div></div>
<p>produced the following</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data/com.android.browser/shared_prefs/xbservice.xml: &lt;string name="URL"&gt;http://www.gotoamazing...
</code></pre></div></div>
<p>The -s option “silent option” stops grep from complaining about trying to grep directories and other invalid files. Note we could have also used -r to recursively search directories but it was fun to use file globbing (wildcard expansion of the * by the shell).</p>
<p>Now we are getting somewhere! It looks like this string is part of the app ‘com.android.browser’ but let’s also find out which app binary code opens the ‘xbservice’ preference. Perhaps this unwanted service is hiding inside another app and managed to secretly load as an extension to the browser?</p>
<p>Let’s look for any file that contains xbservice. This time we will recursively search in the directories of /system that include the ‘app’</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>grep -r -s xbservice /system/*app*
Binary file /system/app/Browser.odex matches
</code></pre></div></div>
<p>Finally - it appears the factory browser was shipped with the the home page hijacking pre-installed. Let’s uninstall it. For this, let’s become root.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ su
# pm list packages -s
</code></pre></div></div>
<p>Android’s package manager has many commands and options. The above example lists all currently installed system apps. We can uninstall the browser app using the following command</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm disable com.android.browser
pm uninstall com.android.browser
</code></pre></div></div>
<p>Using <code class="highlighter-rouge">pm list packages</code> you can list all installed packages (use <code class="highlighter-rouge">-s</code> options to see just system packages). We disabled the following system apps. Of course there is no real guarantee that we successfully removed all unwanted software, or that one of these is a false-positive. As such we would not recommend keeping sensitive information on such a tablet.</p>
<ul>
  <li>com.android.browser</li>
  <li>com.adups.fota.sysoper</li>
  <li>elink.com</li>
  <li>com.google.android.apps.cloudprint</li>
  <li>com.mediatek.CrashService</li>
  <li>com.get.googleApps</li>
  <li>com.adups.fota (an over-the-air package that can install arbitrary items in the future).</li>
  <li>com.mediatek.appguide.plugin</li>
</ul>
<p>It is likely that you could just re-enable a package using <code class="highlighter-rouge">pm enable package-name</code> or <code class="highlighter-rouge">pm install</code> and the relevant .apk file in /system/app or /system/priv-app</p>
</div></div></div>
</div></div>
</div>
        
        <div class="wrapper">
</div>
      </div>
      <div class="col-md-2 col-sm-1 col-xs-0"></div>
    </div>
  </div>
  <script>
    var github_repo = "illinois-cs241/illinois-cs241.github.io";
    var github_path = "_wikibook/file-system-part-8-removing-preinstalled-malware-from-an-android-device.md";
  </script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" crossorigin="anonymous"></script>
<script src="/js/main.js?v=2018-09-08 16:51:38 +0000"></script>

<script>
$(document).ready(function() { 
    $("#tuxlink").prop("href", "javascript:;").click(function() { 
        if ("WebkitAppearance" in document.documentElement.style) { 
            var style = document.createElement("style"); 
            style.setAttribute("id", "tuxstyle"); 
            style.appendChild(document.createTextNode("")); 
            document.head.appendChild(style); 
            var sheet = style.sheet;
            sheet.insertRule("::-webkit-scrollbar-thumb {border-radius: 0; background-color: white; -webkit-box-shadow: none;}", 0); 
        } 

        const hackerKey = 'hackerLocalKey';
        const hackerOff = "off";
        const hackerOn = "on";

        if (window.localStorage.getItem(hackerKey) === null) {
            window.localStorage.setItem(hackerKey, hackerOff);
        }

        $("#tuxlink").unbind('click').click(function() { 
            const hackerClass = 'hacker';
            $('html, body, header, nav, table, pre, span, :not(.card-staff) > a, p, h1, h2, h3, h4, h5, h6').toggleClass(hackerClass);
            $('ul, img, pre').toggleClass(hackerClass);
            $('.toc').toggleClass(hackerClass);
            $('.content .highlighter-rouge').toggleClass(hackerClass);
            $('.large-centered.columns').toggleClass(hackerClass);
            $('.pad').toggleClass(hackerClass);
            $('a').toggleClass(hackerClass);
            $('tbody tr:nth-child(2n+1)').toggleClass(hackerClass);
            $("#tuxlink img").toggleClass(hackerClass);

            const val = window.localStorage.getItem(hackerKey);
            if (val === hackerOff) {
                window.localStorage.setItem(hackerKey, hackerOn);
            } else {
                window.localStorage.setItem(hackerKey, hackerOff);
            }
            return false; 
        }); 
        $("#tuxlink").click();
        const stored = window.localStorage.getItem(hackerKey);
        if (stored === hackerOn) {
            console.log("Hello!")
            $("#tuxlink").click();
        } else {
            console.log("Noo");
        }

        return false; 
    }); 
    } 
    ); 
    </script>

<script src="/js/analytics.js"></script>

<footer class="">

<div class="container-fluid">
<div class="shadow"></div>

</div>

</footer>

</body>
</html>
